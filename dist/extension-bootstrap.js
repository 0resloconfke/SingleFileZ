!function(){"use strict";const e=globalThis.singlefileBootstrap;let t,o,a,n,s,r,i,d,c;async function u(){if(void 0!==document.documentElement.dataset.sfz){const e=new XMLHttpRequest;e.open("GET",location.href),e.send(),e.responseType="arraybuffer",e.onload=()=>l(e.response),e.onerror=()=>{let e=[];browser.runtime.onMessage.addListener((e=>{"singlefile.multipartResponse"==e.method&&o(e)}));const t=document.getElementById("sfz-error-message");function o(t){t.error?browser.runtime.onMessage.removeListener(o):(e.length||document.body.appendChild(document.createTextNode("Please wait...")),e=t.truncated?e.concat(t.array):t.array,t.truncated&&!t.finished||(browser.runtime.onMessage.removeListener(o),l(e)))}t&&t.remove(),browser.runtime.sendMessage({method:"singlefile.multipartFetch",url:location.href})}}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const e=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(e.documentElement,document.documentElement),document.querySelectorAll("script").forEach((e=>{const t=document.createElement("script");t.textContent=e.textContent,e.parentElement.replaceChild(t,e)})),await u()}}function l(e){const t=document.createElement("script");t.textContent="this.bootstrap(["+new Uint8Array(e).toString()+"])",document.body.appendChild(t)}async function m(t){return s&&"content.autosave"==t.method?(async function(e){o=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await p(),o.autoSaveRepeat&&setTimeout((()=>{s&&!i&&(d=!1,o.autoSaveDelay=0,m(e))}),1e3*o.autoSaveRepeatDelay)}(t),{}):"content.maybeInit"==t.method?(v(),{}):"content.init"==t.method?(o=t.options,s=t.autoSaveEnabled,h(),{}):"devtools.resourceCommitted"==t.method?(e.pageInfo.updatedResources[t.url]={content:t.content,type:t.type,encoding:t.encoding},{}):"common.promptValueRequest"==t.method?(browser.runtime.sendMessage({method:"tabs.promptValueResponse",value:prompt("SingleFileZ: "+t.promptMessage)}),{}):void 0}function v(){c==location.href||e.pageInfo.processing||(d=!1,c=location.href,browser.runtime.sendMessage({method:"tabs.init"}),browser.runtime.sendMessage({method:"ui.processInit"}))}async function p(){const t=e.helper;if((!i||r)&&!d)if(i=!0,o.autoSaveDelay&&!r)await new Promise((e=>r=setTimeout(e,1e3*o.autoSaveDelay))),await p();else{const a=window._singleFileZ_waitForUserScript;let n,s=[];r=null,!o.removeFrames&&globalThis.frames&&globalThis.frames.length&&(s=await e.processors.frameTree.getAsync(o)),n=s&&s.sessionId,o.userScriptEnabled&&a&&await a(t.ON_BEFORE_CAPTURE_EVENT_NAME);const c=t.preProcessDoc(document,globalThis,o);S(c,s),n&&e.processors.frameTree.cleanup(n),t.postProcessDoc(document,c.markedElements),o.userScriptEnabled&&a&&await a(t.ON_AFTER_CAPTURE_EVENT_NAME),d=!0,i=!1}}function h(){s&&o&&(o.autoSaveUnload||o.autoSaveLoadOrUnload||o.autoSaveDiscard||o.autoSaveRemove)?t||(globalThis.addEventListener("unload",g),document.addEventListener("visibilitychange",f),t=!0):(globalThis.removeEventListener("unload",g),document.removeEventListener("visibilitychange",f),t=!1)}function f(){"hidden"==document.visibilityState&&o.autoSaveDiscard&&b({autoSaveDiscard:o.autoSaveDiscard})}function g(){!d&&(o.autoSaveUnload||o.autoSaveLoadOrUnload||o.autoSaveRemove)&&b({autoSaveUnload:o.autoSaveUnload,autoSaveRemove:o.autoSaveRemove})}function b({autoSaveUnload:t,autoSaveDiscard:a,autoSaveRemove:n}){const s=e.helper,r=window._singleFile_waitForUserScript;let i=[];!o.removeFrames&&globalThis.frames&&globalThis.frames.length&&(i=e.processors.frameTree.getSync(o)),o.userScriptEnabled&&r&&r(s.ON_BEFORE_CAPTURE_EVENT_NAME);S(s.preProcessDoc(document,globalThis,o),i,{autoSaveUnload:t,autoSaveDiscard:a,autoSaveRemove:n})}function S(t,s,{autoSaveUnload:r,autoSaveDiscard:i,autoSaveRemove:d}={}){const c=e.helper,u=e.pageInfo.updatedResources,l=e.pageInfo.visitDate.getTime();Object.keys(u).forEach((e=>u[e].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:a,tabIndex:n,taskId:o.taskId,content:c.serialize(document),canvases:t.canvases,fonts:t.fonts,stylesheets:t.stylesheets,images:t.images,posters:t.posters,usedFonts:t.usedFonts,shadowRoots:t.shadowRoots,imports:t.imports,referrer:t.referrer,frames:s,url:location.href,updatedResources:u,visitDate:l,autoSaveUnload:r,autoSaveDiscard:i,autoSaveRemove:d})}e.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"autosave.init"}).then((e=>{if(o=e.options,a=e.tabId,n=e.tabIndex,s=e.autoSaveEnabled,"loading"==document.readyState)return new Promise((e=>document.addEventListener("DOMContentLoaded",(()=>e()))))})).then((()=>{h()})),browser.runtime.onMessage.addListener((e=>{if(s&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"devtools.resourceCommitted"==e.method||"common.promptValueRequest"==e.method)return m(e)})),v(),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",u,!1):u())}();
