!function(){"use strict";const e=[0],n=Symbol(),t=new TextEncoder,r=new TextDecoder,i=new Array(256);let o=0;function s(n,t,r,s){if(void 0===s){if(o++,!(i.length-o>=e.length))throw new Error("Reached maximum number of custom types");i[i.length-o]={serialize:n,parse:t,test:r}}else i[s]={serialize:n,parse:t,test:r}}s((function*(e,n){const t=e.objects.indexOf(n);yield*f(e,t)}),(function*(e){const n=yield*p(e);return new m(n,e)}),I,0),s(null,(function*(){return{}}),U),s(a,h,O),s(l,w,(function(e){return"string"==typeof e})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(8*n);return new BigUint64Array(t.buffer)}),(function(e){return e instanceof BigUint64Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(8*n);return new BigInt64Array(t.buffer)}),(function(e){return e instanceof BigInt64Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(8*n);return new Float64Array(t.buffer)}),(function(e){return e instanceof Float64Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(4*n);return new Float32Array(t.buffer)}),(function(e){return e instanceof Float32Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(4*n);return new Uint32Array(t.buffer)}),(function(e){return e instanceof Uint32Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(4*n);return new Int32Array(t.buffer)}),(function(e){return e instanceof Int32Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(2*n);return new Uint16Array(t.buffer)}),(function(e){return e instanceof Uint16Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(2*n);return new Int16Array(t.buffer)}),(function(e){return e instanceof Int16Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(n);return new Uint8ClampedArray(t.buffer)}),(function(e){return e instanceof Uint8ClampedArray})),s(d,(function*(e){const n=yield*p(e);return yield*e.consume(n)}),(function(e){return e instanceof Uint8Array})),s(d,(function*(e){const n=yield*p(e),t=yield*e.consume(n);return new Int8Array(t.buffer)}),(function(e){return e instanceof Int8Array})),s((function*(e,n){yield*f(e,n.byteLength),yield*e.append(new Uint8Array(n))}),(function*(e){const n=yield*p(e);return(yield*e.consume(n)).buffer}),(function(e){return e instanceof ArrayBuffer})),s(y,g,v),s((function*(e,n){const t=new Uint8Array(new BigInt64Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(8);return new BigInt64Array(n.buffer)[0]}),(function(e){return"bigint"==typeof e})),s((function*(e,n){const t=new Uint8Array(new Uint32Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(4);return new Uint32Array(n.buffer)[0]}),(function(e){return M(e)&&e>=0&&e<=4294967295})),s((function*(e,n){const t=new Uint8Array(new Int32Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(4);return new Int32Array(n.buffer)[0]}),(function(e){return M(e)&&e>=-2147483648&&e<=2147483647})),s((function*(e,n){const t=new Uint8Array(new Uint16Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(2);return new Uint16Array(n.buffer)[0]}),(function(e){return M(e)&&e>=0&&e<=65535})),s((function*(e,n){const t=new Uint8Array(new Int16Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(2);return new Int16Array(n.buffer)[0]}),(function(e){return M(e)&&e>=-32768&&e<=32767})),s((function*(e,n){const t=new Uint8Array([n]);yield*e.append(t)}),(function*(e){const n=yield*e.consume(1);return new Uint8Array(n.buffer)[0]}),(function(e){return M(e)&&e>=0&&e<=255})),s((function*(e,n){const t=new Uint8Array(new Int8Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(1);return new Int8Array(n.buffer)[0]}),(function(e){return M(e)&&e>=-128&&e<=127})),s(null,(function*(){return}),(function(e){return void 0===e})),s(null,(function*(){return null}),(function(e){return null===e})),s(null,(function*(){return NaN}),(function(e){return Number.isNaN(e)})),s(b,A,(function(e){return"boolean"==typeof e})),s((function*(e,n){yield*l(e,n.description)}),(function*(e){const n=yield*w(e);return Symbol(n)}),T),s(null,(function*(){return n}),j),s((function*(e,n){const t=n.entries();yield*f(e,n.size);for(const[n,r]of t)yield*f(e,n),yield*f(e,r)}),(function*(e){const n=yield*p(e),t=new Map;for(let r=0;r<n;r++){const n=yield*p(e),r=yield*p(e);e.setObject([n,r],((e,n)=>t.set(e,n)))}return t}),(function(e){return e instanceof Map})),s((function*(e,n){yield*f(e,n.size);for(const t of n)yield*f(e,t)}),(function*(e){const n=yield*p(e),t=new Set;for(let r=0;r<n;r++){const n=yield*p(e);e.setObject([n],(e=>t.add(e)))}return t}),(function(e){return e instanceof Set})),s((function*(e,n){yield*y(e,n.getTime())}),(function*(e){const n=yield*g(e);return new Date(n)}),(function(e){return e instanceof Date})),s((function*(e,n){yield*l(e,n.message),yield*l(e,n.stack)}),(function*(e){const n=yield*w(e),t=yield*w(e),r=new Error(n);return r.stack=t,r}),(function(e){return e instanceof Error})),s((function*(e,n){yield*l(e,n.source),yield*l(e,n.flags)}),(function*(e){const n=yield*w(e),t=yield*w(e);return new RegExp(n,t)}),(function(e){return e instanceof RegExp})),s((function*(e,n){yield*l(e,n.valueOf())}),(function*(e){return new String(yield*w(e))}),(function(e){return e instanceof String})),s((function*(e,n){yield*y(e,n.valueOf())}),(function*(e){return new Number(yield*g(e))}),(function(e){return e instanceof Number})),s((function*(e,n){yield*b(e,n.valueOf())}),(function*(e){return new Boolean(yield*A(e))}),(function(e){return e instanceof Boolean}));class u{constructor(e){this.stream=new c(e),this.objects=[]}append(e){return this.stream.append(e)}flush(){return this.stream.flush()}addObject(e){this.objects.push(function(e){return U(e)||T(e)}(e)&&!I(e,this)?e:void 0)}}class c{constructor(e){this.offset=0,this.value=new Uint8Array(e)}*append(e){if(this.offset+e.length>this.value.length){const n=this.value.length-this.offset;yield*this.append(e.subarray(0,n)),yield this.value,this.offset=0,yield*this.append(e.subarray(n))}else this.value.set(e,this.offset),this.offset+=e.length}*flush(){this.offset&&(yield this.value.subarray(0,this.offset))}}function*f(e,n){const t=i.findIndex((({test:t}={})=>t&&t(n,e)));e.addObject(n),yield*e.append(new Uint8Array([t]));const r=i[t].serialize;r&&(yield*r(e,n)),0!=t&&U(n)&&(yield*function*(e,n){const t=Object.getOwnPropertySymbols(n).map((e=>[e,n[e]]));yield*a(e,t)}(e,n),yield*function*(e,n){let t=Object.entries(n);O(n)&&(t=t.filter((([e])=>!M(Number(e)))));yield*function*(e,n){yield*f(e,n.length);for(const[t,r]of n)yield*l(e,t),yield*f(e,r)}(e,t)}(e,n))}function*a(e,t){yield*f(e,t.length);const r=Object.keys(t).filter((e=>M(Number(e)))).map((e=>Number(e)));let i=0,o=r[i];for(const[s,u]of t.entries())o==s?(o=r[++i],yield*f(e,u)):yield*f(e,n)}function*l(e,n){const r=t.encode(n);yield*f(e,r.length),yield*e.append(r)}function*d(e,n){yield*f(e,n.length),yield*e.append(new Uint8Array(n.buffer))}function*y(e,n){const t=new Uint8Array(new Float64Array([n]).buffer);yield*e.append(t)}function*b(e,n){const t=new Uint8Array([Number(n)]);yield*e.append(t)}class m{constructor(e,n){this.index=e,this.data=n}getObject(){return this.data.objects[this.index]}}function*p(e){const n=(yield*e.consume(1))[0],t=i[n].parse,r=e.getObjectId(),o=yield*t(e);return 0!=n&&U(o)&&(yield*function*(e,n){const t=yield*h(e);e.setObject([t],(e=>e.forEach((([e,t])=>n[e]=t))))}(e,o),yield*function*(e,n){yield*function*(e,n){const t=yield*p(e);for(let r=0;r<t;r++){const t=yield*w(e),r=yield*p(e);e.setObject([r],(e=>n[t]=e))}}(e,n)}(e,o)),e.resolveObject(r,o),o}function*h(e){const n=yield*p(e),t=new Array(n);for(let r=0;r<n;r++){const n=yield*p(e);j(n)||e.setObject([n],(e=>t[r]=e))}return t}function*w(e){const n=yield*p(e),t=yield*e.consume(n);return r.decode(t)}function*g(e){const n=yield*e.consume(8);return new Float64Array(n.buffer)[0]}function*A(e){const n=yield*e.consume(1);return Boolean(n[0])}function I(e,n){return U(e)&&n.objects.includes(e)}function U(e){return e===Object(e)}function O(e){return"number"==typeof e.length}function j(e){return e===n}function v(e){return"number"==typeof e}function M(e){return v(e)&&Number.isInteger(e)}function T(e){return"symbol"==typeof e}const N=new Map;async function E(e,n,t){const r=function*(e,{chunkSize:n=8388608}={}){const t=new u(n);yield*f(t,e),yield*t.flush()}({headers:t.headers,status:t.status,error:t.error,array:t.array});for(const t of r){const r={method:"singlefile.fetchResponse",requestId:n,data:Array.from(t)};await browser.tabs.sendMessage(e,r)}return{}}function R(e,n={},t){return new Promise(((r,i)=>{const o=new XMLHttpRequest;if(o.withCredentials=!0,o.responseType="arraybuffer",o.onerror=e=>i(new Error(e.detail)),o.onreadystatechange=()=>{o.readyState==XMLHttpRequest.DONE&&(o.status||o.response.byteLength?401!=o.status&&403!=o.status&&404!=o.status||t?r({array:new Uint8Array(o.response),headers:{"content-type":o.getResponseHeader("Content-Type")},status:o.status}):R(e,n,!0).then(r).catch(i):i(new Error("Empty response")))},o.open("GET",e,!0),n.headers)for(const e of Object.entries(n.headers))o.setRequestHeader(e[0],e[1]);if(t){const e=String(Math.random()).substring(2);s=e,u=n.referrer,N.set(s,u),o.setRequestHeader("x-single-file-request-id",e)}var s,u;o.send()}))}browser.runtime.onMessage.addListener(((e,n)=>{if(e.method&&e.method.startsWith("singlefile.fetch"))return new Promise((t=>{(async function(e,n){if("singlefile.fetch"==e.method)try{const t=await R(e.url,{referrer:e.referrer,headers:e.headers});return E(n.tab.id,e.requestId,t)}catch(t){return E(n.tab.id,e.requestId,{error:t.message,arrray:[]})}else if("singlefile.fetchFrame"==e.method)return browser.tabs.sendMessage(n.tab.id,e)})(e,n).then(t).catch((e=>t({error:e&&e.toString()})))}))})),browser.runtime.onMessage.addListener(((e,n)=>{if("singlefile.frameTree.initResponse"==e.method||"singlefile.frameTree.ackInitRequest"==e.method)return browser.tabs.sendMessage(n.tab.id,e,{frameId:0}),Promise.resolve({})}));const S=new Map;function x(e,n){e.delete(n)}browser.runtime.onMessage.addListener(((e,n)=>{if("singlefile.lazyTimeout.setTimeout"==e.method){let t,r=S.get(n.tab.id);if(r)if(t=r.get(n.frameId),t){const n=t.get(e.type);n&&clearTimeout(n)}else t=new Map;const i=setTimeout((async()=>{try{const t=S.get(n.tab.id),r=t.get(n.frameId);t&&r&&x(r,e.type),await browser.tabs.sendMessage(n.tab.id,{method:"singlefile.lazyTimeout.onTimeout",type:e.type})}catch(e){}}),e.delay);return r||(r=new Map,t=new Map,r.set(n.frameId,t),S.set(n.tab.id,r)),t.set(e.type,i),Promise.resolve({})}if("singlefile.lazyTimeout.clearTimeout"==e.method){let t=S.get(n.tab.id);if(t){const r=t.get(n.frameId);if(r){const n=r.get(e.type);n&&clearTimeout(n),x(r,e.type)}}return Promise.resolve({})}})),browser.tabs.onRemoved.addListener((e=>S.delete(e)))}();
