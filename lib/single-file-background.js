!function(){"use strict";const n=[0],t=Symbol(),e=new TextEncoder,a=new TextDecoder,r=new Array(256);let i=0;function s(t,e,a,s){if(void 0===s){if(i++,!(r.length-i>=n.length))throw new Error("Reached maximum number of custom types");r[r.length-i]={serialize:t,parse:e,test:a}}else r[s]={serialize:t,parse:e,test:a}}s((async function(n,t){const e=n.objects.indexOf(t);await f(n,e)}),(async function(n){const t=await p(n);return new b(t,n)}),U,0),s(null,(function(){return{}}),v),s(w,h,O),s(y,g,(function(n){return"string"==typeof n})),s(l,(async function(n){const t=await p(n),e=await n.consume(8*t);return new Float64Array(e.buffer)}),(function(n){return n instanceof Float64Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(4*t);return new Float32Array(e.buffer)}),(function(n){return n instanceof Float32Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(4*t);return new Uint32Array(e.buffer)}),(function(n){return n instanceof Uint32Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(4*t);return new Int32Array(e.buffer)}),(function(n){return n instanceof Int32Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(2*t);return new Uint16Array(e.buffer)}),(function(n){return n instanceof Uint16Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(2*t);return new Int16Array(e.buffer)}),(function(n){return n instanceof Int16Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(t);return new Uint8ClampedArray(e.buffer)}),(function(n){return n instanceof Uint8ClampedArray})),s(l,(async function(n){const t=await p(n);return await n.consume(t)}),(function(n){return n instanceof Uint8Array})),s(l,(async function(n){const t=await p(n),e=await n.consume(t);return new Int8Array(e.buffer)}),(function(n){return n instanceof Int8Array})),s((async function(n,t){await f(n,t.byteLength),await n.append(new Uint8Array(t))}),(async function(n){const t=await p(n);return(await n.consume(t)).buffer}),(function(n){return n instanceof ArrayBuffer})),s(d,A,M),s((async function(n,t){const e=new Uint8Array(new Uint32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Uint32Array(t.buffer)[0]}),(function(n){return T(n)&&n>=0&&n<=4294967295})),s((async function(n,t){const e=new Uint8Array(new Int32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Int32Array(t.buffer)[0]}),(function(n){return T(n)&&n>=-2147483648&&n<=2147483647})),s((async function(n,t){const e=new Uint8Array(new Uint16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Uint16Array(t.buffer)[0]}),(function(n){return T(n)&&n>=0&&n<=65535})),s((async function(n,t){const e=new Uint8Array(new Int16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Int16Array(t.buffer)[0]}),(function(n){return T(n)&&n>=-32768&&n<=32767})),s((async function(n,t){const e=new Uint8Array([t]);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Uint8Array(t.buffer)[0]}),(function(n){return T(n)&&n>=0&&n<=255})),s((async function(n,t){const e=new Uint8Array(new Int8Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Int8Array(t.buffer)[0]}),(function(n){return T(n)&&n>=-128&&n<=127})),s(null,(function(){return}),(function(n){return void 0===n})),s(null,(function(){return null}),(function(n){return null===n})),s(null,(function(){return NaN}),(function(n){return Number.isNaN(n)})),s(m,I,(function(n){return"boolean"==typeof n})),s((async function(n,t){await y(n,t.description)}),(async function(n){const t=await g(n);return Symbol(t)}),N),s(null,(function(){return t}),j),s((async function(n,t){const e=t.entries();await f(n,t.size);for(const[t,a]of e)await f(n,t),await f(n,a)}),(async function(n){const t=await p(n),e=new Map;t&&await async function a(r=0){const i=await p(n),s=await p(n);n.setObject([i,s],((n,t)=>e.set(n,t))),r<t-1&&await a(r+1)}();return e}),(function(n){return n instanceof Map})),s((async function(n,t){await f(n,t.size);for(const e of t)await f(n,e)}),(async function(n){const t=await p(n),e=new Set;t&&await async function a(r=0){const i=await p(n);n.setObject([i],(n=>e.add(n))),r<t-1&&await a(r+1)}();return e}),(function(n){return n instanceof Set})),s((async function(n,t){await d(n,t.getTime())}),(async function(n){const t=await A(n);return new Date(t)}),(function(n){return n instanceof Date})),s((async function(n,t){await y(n,t.message),await y(n,t.stack)}),(async function(n){const t=await g(n),e=await g(n),a=new Error(t);return a.stack=e,a}),(function(n){return n instanceof Error})),s((async function(n,t){await y(n,t.source),await y(n,t.flags)}),(async function(n){const t=await g(n),e=await g(n);return new RegExp(t,e)}),(function(n){return n instanceof RegExp})),s((async function(n,t){await y(n,t.valueOf())}),(async function(n){return new String(await g(n))}),(function(n){return n instanceof String})),s((async function(n,t){await d(n,t.valueOf())}),(async function(n){return new Number(await A(n))}),(function(n){return n instanceof Number})),s((async function(n,t){await m(n,t.valueOf())}),(async function(n){return new Boolean(await I(n))}),(function(n){return n instanceof Boolean}));class o{constructor(n,t){this.stream=new c(n,t),this.objects=[]}append(n){return this.stream.append(n)}flush(){return this.stream.flush()}addObject(n){this.objects.push(function(n){return v(n)||N(n)}(n)&&!U(n,this)?n:void 0)}}class c{constructor(n,t){this.offset=0,this.appendData=n,this.value=new Uint8Array(t)}async append(n){if(this.offset+n.length>this.value.length){const t=this.value.length-this.offset;await this.append(n.subarray(0,t)),await this.appendData({value:this.value}),this.offset=0,await this.append(n.subarray(t))}else this.value.set(n,this.offset),this.offset+=n.length}async flush(){this.offset&&await this.appendData({value:this.value.subarray(0,this.offset),done:!0})}}function u(n,{chunkSize:t=8388608}={}){let e,a,r,i,s,c;return{[Symbol.asyncIterator]:()=>({next:()=>i?{done:i}:async function(){c?c():u().catch((()=>{}));s=new Promise((n=>c=n));return{value:await l()}}(),return:()=>({done:!0})})};async function u(){w(),e=new o(y,t),await f(e,n),await e.flush()}function w(){a=new Promise((n=>r=n))}async function y(n){r(n),await s}async function l(){const{value:n,done:t}=await a;return i=t,t||w(),n}}async function f(n,t){const e=r.findIndex((({test:e}={})=>e&&e(t,n)));n.addObject(t),await n.append(new Uint8Array([e]));const a=r[e].serialize;a&&await a(n,t),0!=e&&v(t)&&(await async function(n,t){const e=Object.getOwnPropertySymbols(t).map((n=>[n,t[n]]));await w(n,e)}(n,t),await async function(n,t){let e=Object.entries(t);O(t)&&(e=e.filter((([n])=>!T(Number(n)))));await f(n,e.length);for(const[t,a]of e)await y(n,t),await f(n,a)}(n,t))}async function w(n,e){await f(n,e.length);const a=Object.keys(e).filter((n=>T(Number(n)))).map((n=>Number(n)));let r=0,i=a[r];for(const[s,o]of e.entries())i==s?(i=a[++r],await f(n,o)):await f(n,t)}async function y(n,t){const a=e.encode(t);await f(n,a.length),await n.append(a)}async function l(n,t){await f(n,t.length),await n.append(new Uint8Array(t.buffer))}async function d(n,t){const e=new Uint8Array(new Float64Array([t]).buffer);await n.append(e)}async function m(n,t){const e=new Uint8Array([Number(t)]);await n.append(e)}class b{constructor(n,t){this.index=n,this.data=t}getObject(){return this.data.objects[this.index]}}async function p(n){const t=(await n.consume(1))[0],e=r[t].parse,a=n.getObjectId(),i=await e(n);return 0!=t&&v(i)&&(await async function(n,t){const e=await h(n);n.setObject([e],(n=>n.forEach((([n,e])=>t[n]=e))))}(n,i),await async function(n,t){const e=await p(n);e&&await a();async function a(r=0){const i=await g(n),s=await p(n);n.setObject([s],(n=>t[i]=n)),r<e-1&&await a(r+1)}}(n,i)),n.resolveObject(a,i),i}async function h(n){const t=await p(n),e=new Array(t);return t&&await async function a(r=0){const i=await p(n);j(i)||n.setObject([i],(n=>e[r]=n));r<t-1&&await a(r+1)}(),e}async function g(n){const t=await p(n),e=await n.consume(t);return a.decode(e)}async function A(n){const t=await n.consume(8);return new Float64Array(t.buffer)[0]}async function I(n){const t=await n.consume(1);return Boolean(t[0])}function U(n,t){return v(n)&&t.objects.includes(n)}function v(n){return n===Object(n)}function O(n){return"number"==typeof n.length}function j(n){return n===t}function M(n){return"number"==typeof n}function T(n){return M(n)&&Number.isInteger(n)}function N(n){return"symbol"==typeof n}const R=new Map;async function E(n,t,e){const a=u({headers:e.headers,status:e.status,error:e.error,array:e.array});for await(const e of a)await browser.tabs.sendMessage(n,{method:"singlefile.fetchResponse",requestId:t,data:Array.from(e)});return await browser.tabs.sendMessage(n,{method:"singlefile.fetchResponse",requestId:t}),{}}function S(n,t={},e){return new Promise(((a,r)=>{const i=new XMLHttpRequest;if(i.withCredentials=!0,i.responseType="arraybuffer",i.onerror=n=>r(new Error(n.detail)),i.onreadystatechange=()=>{i.readyState==XMLHttpRequest.DONE&&(i.status||i.response.byteLength?401!=i.status&&403!=i.status&&404!=i.status||e?a({array:new Uint8Array(i.response),headers:{"content-type":i.getResponseHeader("Content-Type")},status:i.status}):S(n,t,!0).then(a).catch(r):r(new Error("Empty response")))},i.open("GET",n,!0),t.headers)for(const n of Object.entries(t.headers))i.setRequestHeader(n[0],n[1]);if(e){const n=String(Math.random()).substring(2);s=n,o=t.referrer,R.set(s,o),i.setRequestHeader("x-single-file-request-id",n)}var s,o;i.send()}))}browser.runtime.onMessage.addListener(((n,t)=>{if(n.method&&n.method.startsWith("singlefile.fetch"))return new Promise((e=>{(async function(n,t){if("singlefile.fetch"==n.method)try{const e=await S(n.url,{referrer:n.referrer,headers:n.headers});return E(t.tab.id,n.requestId,e)}catch(e){return E(t.tab.id,n.requestId,{error:e.message,arrray:[]})}else if("singlefile.fetchFrame"==n.method)return browser.tabs.sendMessage(t.tab.id,n)})(n,t).then(e).catch((n=>e({error:n&&n.toString()})))}))})),browser.runtime.onMessage.addListener(((n,t)=>{if("singlefile.frameTree.initResponse"==n.method||"singlefile.frameTree.ackInitRequest"==n.method)return browser.tabs.sendMessage(t.tab.id,n,{frameId:0}),Promise.resolve({})}));const x=new Map;function q(n,t){n.delete(t)}browser.runtime.onMessage.addListener(((n,t)=>{if("singlefile.lazyTimeout.setTimeout"==n.method){let e,a=x.get(t.tab.id);if(a)if(e=a.get(t.frameId),e){const t=e.get(n.type);t&&clearTimeout(t)}else e=new Map;const r=setTimeout((async()=>{try{const e=x.get(t.tab.id),a=e.get(t.frameId);e&&a&&q(a,n.type),await browser.tabs.sendMessage(t.tab.id,{method:"singlefile.lazyTimeout.onTimeout",type:n.type})}catch(n){}}),n.delay);return a||(a=new Map,e=new Map,a.set(t.frameId,e),x.set(t.tab.id,a)),e.set(n.type,r),Promise.resolve({})}if("singlefile.lazyTimeout.clearTimeout"==n.method){let e=x.get(t.tab.id);if(e){const a=e.get(t.frameId);if(a){const t=a.get(n.type);t&&clearTimeout(t),q(a,n.type)}}return Promise.resolve({})}})),browser.tabs.onRemoved.addListener((n=>x.delete(n)))}();
