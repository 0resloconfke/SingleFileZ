!function(){"use strict";const e=[0],t=Symbol(),n=new TextEncoder,o=new TextDecoder,r=new Array(256);let i=0;function s(t,n,o,s){if(void 0===s){if(i++,!(r.length-i>=e.length))throw new Error("Reached maximum number of custom types");r[r.length-i]={serialize:t,parse:n,test:o}}else r[s]={serialize:t,parse:n,test:o}}s((function*(e,t){const n=e.objects.indexOf(t);yield*c(e,n)}),(function*(e){const t=yield*w(e);return new h(t,e)}),U,0),s(null,(function*(){return{}}),I),s(d,g,T),s(l,A,(function(e){return"string"==typeof e})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(8*t);return new BigUint64Array(n.buffer)}),(function(e){return e instanceof BigUint64Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(8*t);return new BigInt64Array(n.buffer)}),(function(e){return e instanceof BigInt64Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(8*t);return new Float64Array(n.buffer)}),(function(e){return e instanceof Float64Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(4*t);return new Float32Array(n.buffer)}),(function(e){return e instanceof Float32Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(4*t);return new Uint32Array(n.buffer)}),(function(e){return e instanceof Uint32Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(4*t);return new Int32Array(n.buffer)}),(function(e){return e instanceof Int32Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(2*t);return new Uint16Array(n.buffer)}),(function(e){return e instanceof Uint16Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(2*t);return new Int16Array(n.buffer)}),(function(e){return e instanceof Int16Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(t);return new Uint8ClampedArray(n.buffer)}),(function(e){return e instanceof Uint8ClampedArray})),s(f,(function*(e){const t=yield*w(e);return yield*e.consume(t)}),(function(e){return e instanceof Uint8Array})),s(f,(function*(e){const t=yield*w(e),n=yield*e.consume(t);return new Int8Array(n.buffer)}),(function(e){return e instanceof Int8Array})),s((function*(e,t){yield*c(e,t.byteLength),yield*e.append(new Uint8Array(t))}),(function*(e){const t=yield*w(e);return(yield*e.consume(t)).buffer}),(function(e){return e instanceof ArrayBuffer})),s(y,E,D),s((function*(e,t){const n=new Uint8Array(new BigInt64Array([t]).buffer);yield*e.append(n)}),(function*(e){const t=yield*e.consume(8);return new BigInt64Array(t.buffer)[0]}),(function(e){return"bigint"==typeof e})),s((function*(e,t){const n=new Uint8Array(new Uint32Array([t]).buffer);yield*e.append(n)}),(function*(e){const t=yield*e.consume(4);return new Uint32Array(t.buffer)[0]}),(function(e){return j(e)&&e>=0&&e<=4294967295})),s((function*(e,t){const n=new Uint8Array(new Int32Array([t]).buffer);yield*e.append(n)}),(function*(e){const t=yield*e.consume(4);return new Int32Array(t.buffer)[0]}),(function(e){return j(e)&&e>=-2147483648&&e<=2147483647})),s((function*(e,t){const n=new Uint8Array(new Uint16Array([t]).buffer);yield*e.append(n)}),(function*(e){const t=yield*e.consume(2);return new Uint16Array(t.buffer)[0]}),(function(e){return j(e)&&e>=0&&e<=65535})),s((function*(e,t){const n=new Uint8Array(new Int16Array([t]).buffer);yield*e.append(n)}),(function*(e){const t=yield*e.consume(2);return new Int16Array(t.buffer)[0]}),(function(e){return j(e)&&e>=-32768&&e<=32767})),s((function*(e,t){const n=new Uint8Array([t]);yield*e.append(n)}),(function*(e){const t=yield*e.consume(1);return new Uint8Array(t.buffer)[0]}),(function(e){return j(e)&&e>=0&&e<=255})),s((function*(e,t){const n=new Uint8Array(new Int8Array([t]).buffer);yield*e.append(n)}),(function*(e){const t=yield*e.consume(1);return new Int8Array(t.buffer)[0]}),(function(e){return j(e)&&e>=-128&&e<=127})),s(null,(function*(){return}),(function(e){return void 0===e})),s(null,(function*(){return null}),(function(e){return null===e})),s(null,(function*(){return NaN}),(function(e){return Number.isNaN(e)})),s(m,S,(function(e){return"boolean"==typeof e})),s((function*(e,t){yield*l(e,t.description)}),(function*(e){const t=yield*A(e);return Symbol(t)}),N),s(null,(function*(){return t}),R),s((function*(e,t){const n=t.entries();yield*c(e,t.size);for(const[t,o]of n)yield*c(e,t),yield*c(e,o)}),(function*(e){const t=yield*w(e),n=new Map;for(let o=0;o<t;o++){const t=yield*w(e),o=yield*w(e);e.setObject([t,o],((e,t)=>n.set(e,t)))}return n}),(function(e){return e instanceof Map})),s((function*(e,t){yield*c(e,t.size);for(const n of t)yield*c(e,n)}),(function*(e){const t=yield*w(e),n=new Set;for(let o=0;o<t;o++){const t=yield*w(e);e.setObject([t],(e=>n.add(e)))}return n}),(function(e){return e instanceof Set})),s((function*(e,t){yield*y(e,t.getTime())}),(function*(e){const t=yield*E(e);return new Date(t)}),(function(e){return e instanceof Date})),s((function*(e,t){yield*l(e,t.message),yield*l(e,t.stack)}),(function*(e){const t=yield*A(e),n=yield*A(e),o=new Error(t);return o.stack=n,o}),(function(e){return e instanceof Error})),s((function*(e,t){yield*l(e,t.source),yield*l(e,t.flags)}),(function*(e){const t=yield*A(e),n=yield*A(e);return new RegExp(t,n)}),(function(e){return e instanceof RegExp})),s((function*(e,t){yield*l(e,t.valueOf())}),(function*(e){return new String(yield*A(e))}),(function(e){return e instanceof String})),s((function*(e,t){yield*y(e,t.valueOf())}),(function*(e){return new Number(yield*E(e))}),(function(e){return e instanceof Number})),s((function*(e,t){yield*m(e,t.valueOf())}),(function*(e){return new Boolean(yield*S(e))}),(function(e){return e instanceof Boolean}));class a{constructor(e){this.stream=new u(e),this.objects=[]}append(e){return this.stream.append(e)}flush(){return this.stream.flush()}addObject(e){this.objects.push(C(e)&&!U(e,this)?e:void 0)}}class u{constructor(e){this.offset=0,this.value=new Uint8Array(e)}*append(e){if(this.offset+e.length>this.value.length){const t=this.value.length-this.offset;yield*this.append(e.subarray(0,t)),yield this.value,this.offset=0,yield*this.append(e.subarray(t))}else this.value.set(e,this.offset),this.offset+=e.length}*flush(){this.offset&&(yield this.value.subarray(0,this.offset))}}function*c(e,t){const n=r.findIndex((({test:n}={})=>n&&n(t,e)));e.addObject(t),yield*e.append(new Uint8Array([n]));const o=r[n].serialize;o&&(yield*o(e,t)),0!=n&&I(t)&&(yield*function*(e,t){const n=Object.getOwnPropertySymbols(t).map((e=>[e,t[e]]));yield*d(e,n)}(e,t),yield*function*(e,t){let n=Object.entries(t);T(t)&&(n=n.filter((([e])=>!j(Number(e)))));yield*function*(e,t){yield*c(e,t.length);for(const[n,o]of t)yield*l(e,n),yield*c(e,o)}(e,n)}(e,t))}function*d(e,n){yield*c(e,n.length);const o=Object.keys(n).filter((e=>j(Number(e)))).map((e=>Number(e)));let r=0,i=o[r];for(const[s,a]of n.entries())i==s?(i=o[++r],yield*c(e,a)):yield*c(e,t)}function*l(e,t){const o=n.encode(t);yield*c(e,o.length),yield*e.append(o)}function*f(e,t){yield*c(e,t.length),yield*e.append(new Uint8Array(t.buffer))}function*y(e,t){const n=new Uint8Array(new Float64Array([t]).buffer);yield*e.append(n)}function*m(e,t){const n=new Uint8Array([Number(t)]);yield*e.append(n)}class h{constructor(e,t){this.index=e,this.data=t}getObject(){return this.data.objects[this.index]}}class p{constructor(){this.stream=new b,this.objects=[],this.setters=[]}consume(e){return this.stream.consume(e)}getObjectId(){const e=this.objects.length;return this.objects.push(void 0),e}resolveObject(e,t){C(t)&&!O(t)&&(this.objects[e]=t)}setObject(e,t){this.setters.push({functionArguments:e,setterFunction:t})}executeSetters(){this.setters.forEach((({functionArguments:e,setterFunction:t})=>{t(...e.map((e=>O(e)?e.getObject():e)))}))}}class b{constructor(){this.offset=0,this.value=new Uint8Array(0)}*consume(e){if(this.offset+e>this.value.length){const t=this.value.subarray(this.offset,this.value.length),n=yield;return t.length+n.length!=this.value.length&&(this.value=new Uint8Array(t.length+n.length)),this.value.set(t),this.value.set(n,t.length),this.offset=0,yield*this.consume(e)}{const t=this.value.slice(this.offset,this.offset+e);return this.offset+=t.length,t}}}function v(){const e=function*(){const e=new p,t=yield*w(e);return e.executeSetters(),t}();return e.next(),e}function*w(e){const t=(yield*e.consume(1))[0],n=r[t].parse,o=e.getObjectId(),i=yield*n(e);return 0!=t&&I(i)&&(yield*function*(e,t){const n=yield*g(e);e.setObject([n],(e=>e.forEach((([e,n])=>t[e]=n))))}(e,i),yield*function*(e,t){yield*function*(e,t){const n=yield*w(e);for(let o=0;o<n;o++){const n=yield*A(e),o=yield*w(e);e.setObject([o],(e=>t[n]=e))}}(e,t)}(e,i)),e.resolveObject(o,i),i}function*g(e){const t=yield*w(e),n=new Array(t);for(let o=0;o<t;o++){const t=yield*w(e);R(t)||e.setObject([t],(e=>n[o]=e))}return n}function*A(e){const t=yield*w(e),n=yield*e.consume(t);return o.decode(n)}function*E(e){const t=yield*e.consume(8);return new Float64Array(t.buffer)[0]}function*S(e){const t=yield*e.consume(1);return Boolean(t[0])}function U(e,t){return I(e)&&t.objects.includes(e)}function O(e){return e instanceof h}function I(e){return e===Object(e)}function T(e){return"number"==typeof e.length}function R(e){return e===t}function D(e){return"number"==typeof e}function j(e){return D(e)&&Number.isInteger(e)}function N(e){return"symbol"==typeof e}function C(e){return I(e)||N(e)}const M=globalThis.singlefileBootstrap,x=[];let F,L,_,B,P,z,k,q,H;async function V(){if(void 0!==document.documentElement.dataset.sfz){!function(e){const t=document.createElement("script");t.textContent="(() => { const bootstrapReady = this.bootstrap(["+new Uint8Array(e).toString()+']); if (bootstrapReady) { bootstrapReady.then(() => document.dispatchEvent(new CustomEvent("single-filez-display-infobar"))); } })()',document.body.appendChild(t)}(await W())}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const e=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(e.documentElement,document.documentElement),document.querySelectorAll("script").forEach((e=>{const t=document.createElement("script");t.textContent=e.textContent,e.parentElement.replaceChild(t,e)})),await V()}}function W(){return new Promise(((e,t)=>{const n=new XMLHttpRequest;n.open("GET",location.href),n.send(),n.responseType="arraybuffer",n.onload=()=>e(new Uint8Array(n.response)),n.onerror=()=>{const n=v();n.test=new Date;const o=document.getElementById("sfz-error-message");o&&o.remove();const r=setTimeout((()=>{document.body.innerHTML="Please wait...",document.body.hidden=!1}),5e3),i=x.length;x.push({waitTimeout:r,parser:n,resolve:e,reject:t}),browser.runtime.sendMessage({method:"singlefile.fetch",requestId:i,url:location.href})}}))}async function G(e){return P&&"content.autosave"==e.method?(async function(e){L=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await Z(),L.autoSaveRepeat&&setTimeout((()=>{P&&!k&&(q=!1,L.autoSaveDelay=0,G(e))}),1e3*L.autoSaveRepeatDelay)}(e),{}):"content.maybeInit"==e.method?(X(),{}):"content.init"==e.method?(L=e.options,P=e.autoSaveEnabled,$(),{}):"content.openEditor"==e.method?(te(document)?ee():$(),{}):"devtools.resourceCommitted"==e.method?(M.pageInfo.updatedResources[e.url]={content:e.content,type:e.type,encoding:e.encoding},{}):void("singlefile.fetchResponse"==e.method&&function(e){const{parser:t,waitTimeout:n,resolve:o,reject:r}=x[e.requestId],i=t.next(e.data);if(i.done){clearTimeout(n);const e=i.value;e.error?r(new Error(e.error)):o(e.array)}}(e))}function X(){H==location.href||M.pageInfo.processing||(q=!1,H=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:te(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function Z(){const e=M.helper;if((!k||z)&&!q)if(k=!0,L.autoSaveDelay&&!z)await new Promise((e=>z=setTimeout(e,1e3*L.autoSaveDelay))),await Z();else{const t=window._singleFileZ_waitForUserScript;let n,o=[];z=null,!L.removeFrames&&globalThis.frames&&globalThis.frames.length&&(o=await M.processors.frameTree.getAsync(L)),n=o&&o.sessionId,L.userScriptEnabled&&t&&await t(e.ON_BEFORE_CAPTURE_EVENT_NAME);const r=e.preProcessDoc(document,globalThis,L);Y(r,o),n&&M.processors.frameTree.cleanup(n),e.postProcessDoc(document,r.markedElements,r.invalidElements),L.userScriptEnabled&&t&&await t(e.ON_AFTER_CAPTURE_EVENT_NAME),q=!0,k=!1}}function $(){P&&L&&(L.autoSaveUnload||L.autoSaveLoadOrUnload||L.autoSaveDiscard||L.autoSaveRemove)?F||(globalThis.addEventListener("unload",K),document.addEventListener("visibilitychange",J),F=!0):(globalThis.removeEventListener("unload",K),document.removeEventListener("visibilitychange",J),F=!1)}function J(){"hidden"==document.visibilityState&&L.autoSaveDiscard&&Q({autoSaveDiscard:L.autoSaveDiscard})}function K(){!q&&(L.autoSaveUnload||L.autoSaveLoadOrUnload||L.autoSaveRemove)&&Q({autoSaveUnload:L.autoSaveUnload,autoSaveRemove:L.autoSaveRemove})}function Q({autoSaveUnload:e,autoSaveDiscard:t,autoSaveRemove:n}){const o=M.helper,r=window._singleFile_waitForUserScript;let i=[];!L.removeFrames&&globalThis.frames&&globalThis.frames.length&&(i=M.processors.frameTree.getSync(L)),L.userScriptEnabled&&r&&r(o.ON_BEFORE_CAPTURE_EVENT_NAME);Y(o.preProcessDoc(document,globalThis,L),i,{autoSaveUnload:e,autoSaveDiscard:t,autoSaveRemove:n})}function Y(e,t,{autoSaveUnload:n,autoSaveDiscard:o,autoSaveRemove:r}={}){const i=M.helper,s=M.pageInfo.updatedResources,a=M.pageInfo.visitDate.getTime();Object.keys(s).forEach((e=>s[e].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:_,tabIndex:B,taskId:L.taskId,content:i.serialize(document),canvases:e.canvases,fonts:e.fonts,stylesheets:e.stylesheets,images:e.images,posters:e.posters,usedFonts:e.usedFonts,shadowRoots:e.shadowRoots,videos:e.videos,imports:e.imports,referrer:e.referrer,frames:t,url:location.href,updatedResources:s,visitDate:a,autoSaveUnload:n,autoSaveDiscard:o,autoSaveRemove:r})}async function ee(){const e=function*(e,{chunkSize:t=8388608}={}){const n=new a(t);yield*c(n,e),yield*n.flush()}({content:await W(),filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])});for(const t of e){const e={method:"editor.open",data:Array.from(t)};await browser.runtime.sendMessage(e)}}function te(e){const t=M.helper,n=e.documentElement.firstChild;return""==e.documentElement.dataset.sfz||n.nodeType==Node.COMMENT_NODE&&n.textContent.includes(t.COMMENT_HEADER)}M.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{L=e.optionsAutoSave;const t=e.options;_=e.tabId,B=e.tabIndex,P=e.autoSaveEnabled,t&&t.autoOpenEditor&&te(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>ee())):ee():"loading"==document.readyState?document.addEventListener("DOMContentLoaded",$):$()})),browser.runtime.onMessage.addListener((e=>{if(P&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method||"singlefile.fetchResponse"==e.method)return G(e)})),document.addEventListener("DOMContentLoaded",X,!1),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",V,!1):V())}();
