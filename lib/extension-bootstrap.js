!function(){"use strict";const e=globalThis.singlefileBootstrap,t=33554432;let o,n,a,s,r,d,i,c,u;async function l(){if(void 0!==document.documentElement.dataset.sfz){!function(e){const t=document.createElement("script");t.textContent="(() => { const bootstrapReady = this.bootstrap(["+new Uint8Array(e).toString()+']); if (bootstrapReady) { bootstrapReady.then(() => document.dispatchEvent(new CustomEvent("single-filez-display-infobar"))); } })()',document.body.appendChild(t)}(await m())}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const e=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(e.documentElement,document.documentElement),document.querySelectorAll("script").forEach((e=>{const t=document.createElement("script");t.textContent=e.textContent,e.parentElement.replaceChild(t,e)})),await l()}}function m(){return new Promise((e=>{const t=new XMLHttpRequest;t.open("GET",location.href),t.send(),t.responseType="arraybuffer",t.onload=()=>e(Array.from(new Uint8Array(t.response))),t.onerror=()=>{let t=[];browser.runtime.onMessage.addListener((e=>{"singlefile.multipartResponse"==e.method&&n(e)}));const o=document.getElementById("sfz-error-message");function n(o){o.error?browser.runtime.onMessage.removeListener(n):(t.length||document.body.appendChild(document.createTextNode("Please wait...")),t=o.truncated?t.concat(o.array):o.array,o.truncated&&!o.finished||(browser.runtime.onMessage.removeListener(n),e(t)))}o&&o.remove(),browser.runtime.sendMessage({method:"singlefile.multipartFetch",url:location.href})}}))}async function h(t){return r&&"content.autosave"==t.method?(async function(e){n=e.options,"complete"!=document.readyState&&await new Promise((e=>globalThis.addEventListener("load",e)));await p(),n.autoSaveRepeat&&setTimeout((()=>{r&&!i&&(c=!1,n.autoSaveDelay=0,h(e))}),1e3*n.autoSaveRepeatDelay)}(t),{}):"content.maybeInit"==t.method?(v(),{}):"content.init"==t.method?(n=t.options,r=t.autoSaveEnabled,f(),{}):"content.openEditor"==t.method?(w(document)?y():f(),{}):"devtools.resourceCommitted"==t.method?(e.pageInfo.updatedResources[t.url]={content:t.content,type:t.type,encoding:t.encoding},{}):void 0}function v(){u==location.href||e.pageInfo.processing||(c=!1,u=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:w(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function p(){const t=e.helper;if((!i||d)&&!c)if(i=!0,n.autoSaveDelay&&!d)await new Promise((e=>d=setTimeout(e,1e3*n.autoSaveDelay))),await p();else{const o=window._singleFileZ_waitForUserScript;let a,s=[];d=null,!n.removeFrames&&globalThis.frames&&globalThis.frames.length&&(s=await e.processors.frameTree.getAsync(n)),a=s&&s.sessionId,n.userScriptEnabled&&o&&await o(t.ON_BEFORE_CAPTURE_EVENT_NAME);const r=t.preProcessDoc(document,globalThis,n);S(r,s),a&&e.processors.frameTree.cleanup(a),t.postProcessDoc(document,r.markedElements,r.invalidElements),n.userScriptEnabled&&o&&await o(t.ON_AFTER_CAPTURE_EVENT_NAME),c=!0,i=!1}}function f(){r&&n&&(n.autoSaveUnload||n.autoSaveLoadOrUnload||n.autoSaveDiscard||n.autoSaveRemove)?o||(globalThis.addEventListener("unload",E),document.addEventListener("visibilitychange",g),o=!0):(globalThis.removeEventListener("unload",E),document.removeEventListener("visibilitychange",g),o=!1)}function g(){"hidden"==document.visibilityState&&n.autoSaveDiscard&&b({autoSaveDiscard:n.autoSaveDiscard})}function E(){!c&&(n.autoSaveUnload||n.autoSaveLoadOrUnload||n.autoSaveRemove)&&b({autoSaveUnload:n.autoSaveUnload,autoSaveRemove:n.autoSaveRemove})}function b({autoSaveUnload:t,autoSaveDiscard:o,autoSaveRemove:a}){const s=e.helper,r=window._singleFile_waitForUserScript;let d=[];!n.removeFrames&&globalThis.frames&&globalThis.frames.length&&(d=e.processors.frameTree.getSync(n)),n.userScriptEnabled&&r&&r(s.ON_BEFORE_CAPTURE_EVENT_NAME);S(s.preProcessDoc(document,globalThis,n),d,{autoSaveUnload:t,autoSaveDiscard:o,autoSaveRemove:a})}function S(t,o,{autoSaveUnload:r,autoSaveDiscard:d,autoSaveRemove:i}={}){const c=e.helper,u=e.pageInfo.updatedResources,l=e.pageInfo.visitDate.getTime();Object.keys(u).forEach((e=>u[e].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:a,tabIndex:s,taskId:n.taskId,content:c.serialize(document),canvases:t.canvases,fonts:t.fonts,stylesheets:t.stylesheets,images:t.images,posters:t.posters,usedFonts:t.usedFonts,shadowRoots:t.shadowRoots,imports:t.imports,referrer:t.referrer,frames:o,url:location.href,updatedResources:u,visitDate:l,autoSaveUnload:r,autoSaveDiscard:d,autoSaveRemove:i})}async function y(){const e=await m();for(let o=0;o*t<e.length;o++){const n={method:"editor.open",filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])};n.truncated=e.length>t,n.truncated?(n.finished=(o+1)*t>e.length,n.content=e.slice(o*t,(o+1)*t)):n.content=e,await browser.runtime.sendMessage(n)}}function w(t){const o=e.helper,n=t.documentElement.firstChild;return""==t.documentElement.dataset.sfz||n.nodeType==Node.COMMENT_NODE&&n.textContent.includes(o.COMMENT_HEADER)}e.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((e=>{n=e.optionsAutoSave;const t=e.options;a=e.tabId,s=e.tabIndex,r=e.autoSaveEnabled,t&&t.autoOpenEditor&&w(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>y())):y():"loading"==document.readyState?document.addEventListener("DOMContentLoaded",f):f()})),browser.runtime.onMessage.addListener((e=>{if(r&&"content.autosave"==e.method||"content.maybeInit"==e.method||"content.init"==e.method||"content.openEditor"==e.method||"devtools.resourceCommitted"==e.method)return h(e)})),document.addEventListener("DOMContentLoaded",v,!1),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",l,!1):l())}();
