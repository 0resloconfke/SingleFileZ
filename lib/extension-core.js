!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).extension={})}(this,(function(e){"use strict";let n,t;const r=["lib/chrome-browser-polyfill.js","lib/single-file.js"],i=["lib/chrome-browser-polyfill.js","lib/single-file-frames.js"];async function o(e,o){let c;if(await async function(e){const o=e.extensionScriptFiles||[];n||t||([n,t]=await Promise.all([u(r.concat(o)),u(i)]))}(o),!o.removeFrames)try{await browser.tabs.executeScript(e,{code:t,allFrames:!0,matchAboutBlank:!0,runAt:"document_start"})}catch(e){}try{await browser.tabs.executeScript(e,{code:n,allFrames:!1,runAt:"document_idle"}),c=!0}catch(e){}return c&&o.frameId&&await browser.tabs.executeScript(e,{code:"document.documentElement.dataset.requestedFrameId = true",frameId:o.frameId,matchAboutBlank:!0,runAt:"document_start"}),c}async function u(e){const n=e.map((async e=>{if("function"==typeof e)return"("+e.toString()+")();";{const n=await fetch(browser.runtime.getURL("../../../"+e));return(new TextDecoder).decode(await n.arrayBuffer())}}));let t="";for(const e of n)t+=await e;return t}const c=[0],s=Symbol(),f=new TextEncoder,a=new TextDecoder,l=new Array(256);let d=0;function y(e,n,t,r){if(void 0===r){if(d++,!(l.length-d>=c.length))throw new Error("Reached maximum number of custom types");l[l.length-d]={serialize:e,parse:n,test:t}}else l[r]={serialize:e,parse:n,test:t}}function*w(e,n){const t=l.findIndex((({test:t}={})=>t&&t(n,e)));e.addObject(n),yield*e.append(new Uint8Array([t]));const r=l[t].serialize;r&&(yield*r(e,n)),0!=t&&E(n)&&(yield*function*(e,n){const t=Object.getOwnPropertySymbols(n).map((e=>[e,n[e]]));yield*h(e,t)}(e,n),yield*function*(e,n){let t=Object.entries(n);N(n)&&(t=t.filter((([e])=>!T(Number(e)))));yield*function*(e,n){yield*w(e,n.length);for(const[t,r]of n)yield*m(e,t),yield*w(e,r)}(e,t)}(e,n))}function*h(e,n){yield*w(e,n.length);const t=Object.keys(n).filter((e=>T(Number(e)))).map((e=>Number(e)));let r=0,i=t[r];for(const[o,u]of n.entries())i==o?(i=t[++r],yield*w(e,u)):yield*w(e,s)}function*m(e,n){const t=f.encode(n);yield*w(e,t.length),yield*e.append(t)}function*b(e,n){yield*w(e,n.length),yield*e.append(new Uint8Array(n.buffer))}function*p(e,n){const t=new Uint8Array(new Float64Array([n]).buffer);yield*e.append(t)}function*g(e,n){const t=new Uint8Array([Number(n)]);yield*e.append(t)}y((function*(e,n){const t=e.objects.indexOf(n);yield*w(e,t)}),(function*(e){const n=yield*v(e);return new A(n,e)}),(function(e,n){return E(e)&&n.objects.includes(e)}),0),y(null,(function*(){return{}}),E),y(h,O,N),y(m,x,(function(e){return"string"==typeof e})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(8*n);return new BigUint64Array(t.buffer)}),(function(e){return e instanceof BigUint64Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(8*n);return new BigInt64Array(t.buffer)}),(function(e){return e instanceof BigInt64Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(8*n);return new Float64Array(t.buffer)}),(function(e){return e instanceof Float64Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(4*n);return new Float32Array(t.buffer)}),(function(e){return e instanceof Float32Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(4*n);return new Uint32Array(t.buffer)}),(function(e){return e instanceof Uint32Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(4*n);return new Int32Array(t.buffer)}),(function(e){return e instanceof Int32Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(2*n);return new Uint16Array(t.buffer)}),(function(e){return e instanceof Uint16Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(2*n);return new Int16Array(t.buffer)}),(function(e){return e instanceof Int16Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(n);return new Uint8ClampedArray(t.buffer)}),(function(e){return e instanceof Uint8ClampedArray})),y(b,(function*(e){const n=yield*v(e);return yield*e.consume(n)}),(function(e){return e instanceof Uint8Array})),y(b,(function*(e){const n=yield*v(e),t=yield*e.consume(n);return new Int8Array(t.buffer)}),(function(e){return e instanceof Int8Array})),y((function*(e,n){yield*w(e,n.byteLength),yield*e.append(new Uint8Array(n))}),(function*(e){const n=yield*v(e);return(yield*e.consume(n)).buffer}),(function(e){return e instanceof ArrayBuffer})),y(p,B,M),y((function*(e,n){const t=new Uint8Array(new BigInt64Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(8);return new BigInt64Array(n.buffer)[0]}),(function(e){return"bigint"==typeof e})),y((function*(e,n){const t=new Uint8Array(new Uint32Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(4);return new Uint32Array(n.buffer)[0]}),(function(e){return T(e)&&e>=0&&e<=4294967295})),y((function*(e,n){const t=new Uint8Array(new Int32Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(4);return new Int32Array(n.buffer)[0]}),(function(e){return T(e)&&e>=-2147483648&&e<=2147483647})),y((function*(e,n){const t=new Uint8Array(new Uint16Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(2);return new Uint16Array(n.buffer)[0]}),(function(e){return T(e)&&e>=0&&e<=65535})),y((function*(e,n){const t=new Uint8Array(new Int16Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(2);return new Int16Array(n.buffer)[0]}),(function(e){return T(e)&&e>=-32768&&e<=32767})),y((function*(e,n){const t=new Uint8Array([n]);yield*e.append(t)}),(function*(e){const n=yield*e.consume(1);return new Uint8Array(n.buffer)[0]}),(function(e){return T(e)&&e>=0&&e<=255})),y((function*(e,n){const t=new Uint8Array(new Int8Array([n]).buffer);yield*e.append(t)}),(function*(e){const n=yield*e.consume(1);return new Int8Array(n.buffer)[0]}),(function(e){return T(e)&&e>=-128&&e<=127})),y(null,(function*(){return}),(function(e){return void 0===e})),y(null,(function*(){return null}),(function(e){return null===e})),y(null,(function*(){return NaN}),(function(e){return Number.isNaN(e)})),y(g,S,(function(e){return"boolean"==typeof e})),y((function*(e,n){yield*m(e,n.description)}),(function*(e){const n=yield*x(e);return Symbol(n)}),z),y(null,(function*(){return s}),P),y((function*(e,n){const t=n.entries();yield*w(e,n.size);for(const[n,r]of t)yield*w(e,n),yield*w(e,r)}),(function*(e){const n=yield*v(e),t=new Map;for(let r=0;r<n;r++){const n=yield*v(e),r=yield*v(e);e.setObject([n,r],((e,n)=>t.set(e,n)))}return t}),(function(e){return e instanceof Map})),y((function*(e,n){yield*w(e,n.size);for(const t of n)yield*w(e,t)}),(function*(e){const n=yield*v(e),t=new Set;for(let r=0;r<n;r++){const n=yield*v(e);e.setObject([n],(e=>t.add(e)))}return t}),(function(e){return e instanceof Set})),y((function*(e,n){yield*p(e,n.getTime())}),(function*(e){const n=yield*B(e);return new Date(n)}),(function(e){return e instanceof Date})),y((function*(e,n){yield*m(e,n.message),yield*m(e,n.stack)}),(function*(e){const n=yield*x(e),t=yield*x(e),r=new Error(n);return r.stack=t,r}),(function(e){return e instanceof Error})),y((function*(e,n){yield*m(e,n.source),yield*m(e,n.flags)}),(function*(e){const n=yield*x(e),t=yield*x(e);return new RegExp(n,t)}),(function(e){return e instanceof RegExp})),y((function*(e,n){yield*m(e,n.valueOf())}),(function*(e){return new String(yield*x(e))}),(function(e){return e instanceof String})),y((function*(e,n){yield*p(e,n.valueOf())}),(function*(e){return new Number(yield*B(e))}),(function(e){return e instanceof Number})),y((function*(e,n){yield*g(e,n.valueOf())}),(function*(e){return new Boolean(yield*S(e))}),(function(e){return e instanceof Boolean}));class A{constructor(e,n){this.index=e,this.data=n}getObject(){return this.data.objects[this.index]}}class j{constructor(){this.stream=new I,this.objects=[],this.setters=[]}consume(e){return this.stream.consume(e)}getObjectId(){const e=this.objects.length;return this.objects.push(void 0),e}resolveObject(e,n){(function(e){return E(e)||z(e)})(n)&&!F(n)&&(this.objects[e]=n)}setObject(e,n){this.setters.push({functionArguments:e,setterFunction:n})}executeSetters(){this.setters.forEach((({functionArguments:e,setterFunction:n})=>{n(...e.map((e=>F(e)?e.getObject():e)))}))}}class I{constructor(){this.offset=0,this.value=new Uint8Array(0)}*consume(e){if(this.offset+e>this.value.length){const n=this.value.subarray(this.offset,this.value.length),t=yield;return n.length+t.length!=this.value.length&&(this.value=new Uint8Array(n.length+t.length)),this.value.set(n),this.value.set(t,n.length),this.offset=0,yield*this.consume(e)}{const n=this.value.slice(this.offset,this.offset+e);return this.offset+=n.length,n}}}function U(){const e=function*(){const e=new j,n=yield*v(e);return e.executeSetters(),n}();return e.next(),e}function*v(e){const n=(yield*e.consume(1))[0],t=l[n].parse,r=e.getObjectId(),i=yield*t(e);return 0!=n&&E(i)&&(yield*function*(e,n){const t=yield*O(e);e.setObject([t],(e=>e.forEach((([e,t])=>n[e]=t))))}(e,i),yield*function*(e,n){yield*function*(e,n){const t=yield*v(e);for(let r=0;r<t;r++){const t=yield*x(e),r=yield*v(e);e.setObject([r],(e=>n[t]=e))}}(e,n)}(e,i)),e.resolveObject(r,i),i}function*O(e){const n=yield*v(e),t=new Array(n);for(let r=0;r<n;r++){const n=yield*v(e);P(n)||e.setObject([n],(e=>t[r]=e))}return t}function*x(e){const n=yield*v(e),t=yield*e.consume(n);return a.decode(t)}function*B(e){const n=yield*e.consume(8);return new Float64Array(n.buffer)[0]}function*S(e){const n=yield*e.consume(1);return Boolean(n[0])}function F(e){return e instanceof A}function E(e){return e===Object(e)}function N(e){return"number"==typeof e.length}function P(e){return e===s}function M(e){return"number"==typeof e}function T(e){return M(e)&&Number.isInteger(e)}function z(e){return"symbol"==typeof e}const D="single-filez-response-fetch",k=(e,n)=>window.fetch(e,n);let q=0,L=new Map;async function R(e,n={}){try{let t=await k(e,{cache:"force-cache",headers:n.headers});return 401!=t.status&&403!=t.status&&404!=t.status||(t=await G(e)),t}catch(t){q++;const r=new Promise(((e,n)=>L.set(q,{resolve:e,reject:n,parser:U()})));return await C({method:"singlefile.fetch",url:e,requestId:q,referrer:n.referrer,headers:n.headers}),r}}async function _(e,n){const t=await C({method:"singlefile.fetchFrame",url:e,frameId:n.frameId,referrer:n.referrer,headers:n.headers});return{status:t.status,headers:new Map(t.headers),arrayBuffer:async()=>new Uint8Array(t.array).buffer}}async function C(e){const n=await browser.runtime.sendMessage(e);if(!n||n.error)throw new Error(n&&n.error&&n.error.toString());return n}function G(e){return new Promise(((n,t)=>{var r,i,o,u;r=new CustomEvent("single-filez-request-fetch",{detail:e}),window.dispatchEvent(r),i=D,o=function r(i){var o,u,c;i.detail?i.detail.url==e&&(o=D,u=r,c=!1,window.removeEventListener(o,u,c),i.detail.response?n({status:i.detail.status,headers:new Map(i.detail.headers),arrayBuffer:async()=>i.detail.response}):t(i.detail.error)):t()},u=!1,window.addEventListener(i,o,u)}))}browser.runtime.onMessage.addListener((e=>"singlefile.fetchFrame"==e.method&&window.frameId&&window.frameId==e.frameId?async function(e){try{let n=await k(e.url,{cache:"force-cache",headers:e.headers});return 401!=n.status&&403!=n.status&&404!=n.status||(n=await Promise.race([G(e.url),new Promise(((e,n)=>setTimeout((()=>n()),5e3)))])),{status:n.status,headers:[...n.headers],array:Array.from(new Uint8Array(await n.arrayBuffer()))}}catch(e){return{error:e&&e.toString()}}}(e):"singlefile.fetchResponse"==e.method?async function(e){let n=L.get(e.requestId);if(n){const t=n.parser.next(e.data);if(t.done){L.delete(e.requestId);const r=t.value;r.error?n.reject(new Error(r.error)):n.resolve({status:r.status,headers:{get:e=>r.headers&&r.headers[e]},arrayBuffer:async()=>r.array.buffer})}}return{}}(e):void 0)),e.getPageData=function(e,n,t,r={fetch:R,frameFetch:_}){return globalThis.singlefile.getPageData(e,r,n,t)},e.injectScript=function(e,n){return o(e,n)},Object.defineProperty(e,"__esModule",{value:!0})}));
