!function(){"use strict";const t=[0],n=Symbol(),e=new TextEncoder,a=new TextDecoder,o=new Array(256);let s=0;function r(n,e,a,r){if(void 0===r){if(s++,!(o.length-s>=t.length))throw new Error("Reached maximum number of custom types");o[o.length-s]={serialize:n,parse:e,test:a}}else o[r]={serialize:n,parse:e,test:a}}r((async function(t,n){const e=t.objects.indexOf(n);await f(t,e)}),(async function(t){const n=await g(t);return new h(n,t)}),O,0),r(null,(function(){return{}}),D),r(d,E,R),r(l,A,(function(t){return"string"==typeof t})),r(w,(async function(t){const n=await g(t),e=await t.consume(8*n);return new Float64Array(e.buffer)}),(function(t){return t instanceof Float64Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(4*n);return new Float32Array(e.buffer)}),(function(t){return t instanceof Float32Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(4*n);return new Uint32Array(e.buffer)}),(function(t){return t instanceof Uint32Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(4*n);return new Int32Array(e.buffer)}),(function(t){return t instanceof Int32Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(2*n);return new Uint16Array(e.buffer)}),(function(t){return t instanceof Uint16Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(2*n);return new Int16Array(e.buffer)}),(function(t){return t instanceof Int16Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(n);return new Uint8ClampedArray(e.buffer)}),(function(t){return t instanceof Uint8ClampedArray})),r(w,(async function(t){const n=await g(t);return await t.consume(n)}),(function(t){return t instanceof Uint8Array})),r(w,(async function(t){const n=await g(t),e=await t.consume(n);return new Int8Array(e.buffer)}),(function(t){return t instanceof Int8Array})),r((async function(t,n){await f(t,n.byteLength),await t.append(new Uint8Array(n))}),(async function(t){const n=await g(t);return(await t.consume(n)).buffer}),(function(t){return t instanceof ArrayBuffer})),r(m,S,j),r((async function(t,n){const e=new Uint8Array(new Uint32Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(4);return new Uint32Array(n.buffer)[0]}),(function(t){return N(t)&&t>=0&&t<=4294967295})),r((async function(t,n){const e=new Uint8Array(new Int32Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(4);return new Int32Array(n.buffer)[0]}),(function(t){return N(t)&&t>=-2147483648&&t<=2147483647})),r((async function(t,n){const e=new Uint8Array(new Uint16Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(2);return new Uint16Array(n.buffer)[0]}),(function(t){return N(t)&&t>=0&&t<=65535})),r((async function(t,n){const e=new Uint8Array(new Int16Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(2);return new Int16Array(n.buffer)[0]}),(function(t){return N(t)&&t>=-32768&&t<=32767})),r((async function(t,n){const e=new Uint8Array([n]);await t.append(e)}),(async function(t){const n=await t.consume(1);return new Uint8Array(n.buffer)[0]}),(function(t){return N(t)&&t>=0&&t<=255})),r((async function(t,n){const e=new Uint8Array(new Int8Array([n]).buffer);await t.append(e)}),(async function(t){const n=await t.consume(1);return new Int8Array(n.buffer)[0]}),(function(t){return N(t)&&t>=-128&&t<=127})),r(null,(function(){return}),(function(t){return void 0===t})),r(null,(function(){return null}),(function(t){return null===t})),r(null,(function(){return NaN}),(function(t){return Number.isNaN(t)})),r(y,U,(function(t){return"boolean"==typeof t})),r((async function(t,n){await l(t,n.description)}),(async function(t){const n=await A(t);return Symbol(n)}),C),r(null,(function(){return n}),T),r((async function(t,n){const e=n.entries();await f(t,n.size);for(const[n,a]of e)await f(t,n),await f(t,a)}),(async function(t){const n=await g(t),e=new Map;n&&await async function a(o=0){const s=await g(t),r=await g(t);t.setObject([s,r],((t,n)=>e.set(t,n))),o<n-1&&await a(o+1)}();return e}),(function(t){return t instanceof Map})),r((async function(t,n){await f(t,n.size);for(const e of n)await f(t,e)}),(async function(t){const n=await g(t),e=new Set;n&&await async function a(o=0){const s=await g(t);t.setObject([s],(t=>e.add(t))),o<n-1&&await a(o+1)}();return e}),(function(t){return t instanceof Set})),r((async function(t,n){await m(t,n.getTime())}),(async function(t){const n=await S(t);return new Date(n)}),(function(t){return t instanceof Date})),r((async function(t,n){await l(t,n.message),await l(t,n.stack)}),(async function(t){const n=await A(t),e=await A(t),a=new Error(n);return a.stack=e,a}),(function(t){return t instanceof Error})),r((async function(t,n){await l(t,n.source),await l(t,n.flags)}),(async function(t){const n=await A(t),e=await A(t);return new RegExp(n,e)}),(function(t){return t instanceof RegExp})),r((async function(t,n){await l(t,n.valueOf())}),(async function(t){return new String(await A(t))}),(function(t){return t instanceof String})),r((async function(t,n){await m(t,n.valueOf())}),(async function(t){return new Number(await S(t))}),(function(t){return t instanceof Number})),r((async function(t,n){await y(t,n.valueOf())}),(async function(t){return new Boolean(await U(t))}),(function(t){return t instanceof Boolean}));class i{constructor(t,n){this.stream=new c(t,n),this.objects=[]}append(t){return this.stream.append(t)}flush(){return this.stream.flush()}addObject(t){this.objects.push(x(t)&&!O(t,this)?t:void 0)}}class c{constructor(t,n){this.offset=0,this.appendData=t,this.value=new Uint8Array(n)}async append(t){if(this.offset+t.length>this.value.length){const n=this.value.length-this.offset;await this.append(t.subarray(0,n)),await this.appendData({value:this.value}),this.offset=0,await this.append(t.subarray(n))}else this.value.set(t,this.offset),this.offset+=t.length}async flush(){this.offset&&await this.appendData({value:this.value.subarray(0,this.offset),done:!0})}}function u(t,{chunkSize:n=8388608}={}){let e,a,o,s,r,c;return{[Symbol.asyncIterator]:()=>({next:()=>s?{done:s}:async function(){c?c():u().catch((()=>{}));r=new Promise((t=>c=t));const t=await async function(){const{value:t,done:n}=await a;s=n,n||d();return t}();return{value:t}}(),return:()=>({done:!0})})};async function u(){d(),e=new i(l,n),await f(e,t),await e.flush()}function d(){a=new Promise((t=>o=t))}async function l(t){o(t),await r}}async function f(t,n){const e=o.findIndex((({test:e}={})=>e&&e(n,t)));t.addObject(n),await t.append(new Uint8Array([e]));const a=o[e].serialize;a&&await a(t,n),0!=e&&D(n)&&(await async function(t,n){const e=Object.getOwnPropertySymbols(n),a=e.map((t=>[t,n[t]]));await d(t,a)}(t,n),await async function(t,n){let e=Object.entries(n);R(n)&&(e=e.filter((([t])=>!N(Number(t)))));await f(t,e.length);for(const[n,a]of e)await l(t,n),await f(t,a)}(t,n))}async function d(t,e){await f(t,e.length);const a=Object.keys(e).filter((t=>N(Number(t)))).map((t=>Number(t)));let o=0,s=a[o];for(const[r,i]of e.entries())s==r?(s=a[++o],await f(t,i)):await f(t,n)}async function l(t,n){const a=e.encode(n);await f(t,a.length),await t.append(a)}async function w(t,n){await f(t,n.length),await t.append(new Uint8Array(n.buffer))}async function m(t,n){const e=new Uint8Array(new Float64Array([n]).buffer);await t.append(e)}async function y(t,n){const e=new Uint8Array([Number(n)]);await t.append(e)}class h{constructor(t,n){this.index=t,this.data=n}getObject(){return this.data.objects[this.index]}}class p{constructor(t){this.stream=new b(t),this.objects=[],this.setters=[]}consume(t){return this.stream.consume(t)}getObjectId(){const t=this.objects.length;return this.objects.push(void 0),t}resolveObject(t,n){x(n)&&!I(n)&&(this.objects[t]=n)}setObject(t,n){this.setters.push({functionArguments:t,setterFunction:n})}executeSetters(){this.setters.forEach((({functionArguments:t,setterFunction:n})=>{n(...t.map((t=>I(t)?t.getObject():t)))}))}}class b{constructor(t){this.offset=0,this.value=new Uint8Array(0),this.consumeData=t}async consume(t){if(this.offset+t>this.value.length){const n=this.value.subarray(this.offset,this.value.length),e=await this.consumeData();return n.length+e.length!=this.value.length&&(this.value=new Uint8Array(n.length+e.length)),this.value.set(n),this.value.set(e,n.length),this.offset=0,this.consume(t)}{const n=this.value.slice(this.offset,this.offset+t);return this.offset+=n.length,n}}}function v(){let t,n,e,a,o,s;return{next:async n=>n?async function(n){o?await o:async function(){let n;a=new Promise((t=>n=t)),t=new p(i),r();const e=await g(t);t.executeSetters(),n(e)}().catch((()=>{}));return function(){o=new Promise((t=>s=t))}(),e(n),{done:!1}}(n):{value:await a,done:!0},return:()=>({done:!0})};function r(){n=new Promise((t=>e=t))}async function i(){const t=await n;return r(),s&&s(),t}}async function g(t){const n=(await t.consume(1))[0],e=o[n].parse,a=t.getObjectId(),s=await e(t);return 0!=n&&D(s)&&(await async function(t,n){const e=await E(t);t.setObject([e],(t=>t.forEach((([t,e])=>n[t]=e))))}(t,s),await async function(t,n){const e=await g(t);e&&await a();async function a(o=0){const s=await A(t),r=await g(t);t.setObject([r],(t=>n[s]=t)),o<e-1&&await a(o+1)}}(t,s)),t.resolveObject(a,s),s}async function E(t){const n=await g(t),e=new Array(n);return n&&await async function a(o=0){const s=await g(t);T(s)||t.setObject([s],(t=>e[o]=t));o<n-1&&await a(o+1)}(),e}async function A(t){const n=await g(t),e=await t.consume(n);return a.decode(e)}async function S(t){const n=await t.consume(8);return new Float64Array(n.buffer)[0]}async function U(t){const n=await t.consume(1);return Boolean(n[0])}function O(t,n){return D(t)&&n.objects.includes(t)}function I(t){return t instanceof h}function D(t){return t===Object(t)}function R(t){return"number"==typeof t.length}function T(t){return t===n}function j(t){return"number"==typeof t}function N(t){return j(t)&&Number.isInteger(t)}function C(t){return"symbol"==typeof t}function x(t){return D(t)||C(t)}const M=globalThis.singlefileBootstrap,F=[];let L,P,_,z,k,B,q,V,H;async function W(){if(void 0!==document.documentElement.dataset.sfz){!function(t){const n=document.createElement("script");n.textContent="(() => { const bootstrapReady = this.bootstrap && this.bootstrap(["+new Uint8Array(t).toString()+']); if (bootstrapReady) { bootstrapReady.then(() => document.dispatchEvent(new CustomEvent("single-filez-display-infobar"))); } })()',document.body.appendChild(n)}(await G())}else if(document.body&&1==document.body.childNodes.length&&"PRE"==document.body.childNodes[0].tagName&&/<html[^>]* data-sfz[^>]*>/i.test(document.body.childNodes[0].textContent)){const t=(new DOMParser).parseFromString(document.body.childNodes[0].textContent,"text/html");document.replaceChild(t.documentElement,document.documentElement),document.querySelectorAll("script").forEach((t=>{const n=document.createElement("script");n.textContent=t.textContent,t.parentElement.replaceChild(n,t)})),await W()}}function G(){return new Promise(((t,n)=>{const e=new XMLHttpRequest;e.open("GET",location.href),e.send(),e.responseType="arraybuffer",e.onload=()=>t(new Uint8Array(e.response)),e.onerror=()=>{const e=v();e.test=new Date;const a=document.getElementById("sfz-error-message");a&&a.remove();const o=F.length;F.push({parser:e,resolve:t,reject:n}),browser.runtime.sendMessage({method:"singlefile.fetch",requestId:o,url:location.href})}}))}async function X(t){return k&&"content.autosave"==t.method?(async function(t){P=t.options,"complete"!=document.readyState&&await new Promise((t=>globalThis.addEventListener("load",t)));await $(),P.autoSaveRepeat&&setTimeout((()=>{k&&!q&&(V=!1,P.autoSaveDelay=0,X(t))}),1e3*P.autoSaveRepeatDelay)}(t),{}):"content.maybeInit"==t.method?(Z(),{}):"content.init"==t.method?(P=t.options,k=t.autoSaveEnabled,J(),{}):"content.openEditor"==t.method?(et(document)?nt():J(),{}):"devtools.resourceCommitted"==t.method?(M.pageInfo.updatedResources[t.url]={content:t.content,type:t.type,encoding:t.encoding},{}):void("singlefile.fetchResponse"==t.method&&async function(t){if(F[t.requestId]){const{parser:n,resolve:e,reject:a}=F[t.requestId],o=await n.next(t.data);if(o.done){const t=o.value;t.error?a(new Error(t.error)):e(t.array)}}}(t))}function Z(){H==location.href||M.pageInfo.processing||(V=!1,H=location.href,browser.runtime.sendMessage({method:"tabs.init",savedPageDetected:et(document)}).catch((()=>{})),browser.runtime.sendMessage({method:"ui.processInit"}).catch((()=>{})))}async function $(){const t=M.helper;if((!q||B)&&!V)if(q=!0,P.autoSaveDelay&&!B)await new Promise((t=>B=setTimeout(t,1e3*P.autoSaveDelay))),await $();else{const n=window._singleFileZ_waitForUserScript;let e,a=[];B=null,!P.removeFrames&&globalThis.frames&&globalThis.frames.length&&(a=await M.processors.frameTree.getAsync(P)),e=a&&a.sessionId,P.userScriptEnabled&&n&&await n(t.ON_BEFORE_CAPTURE_EVENT_NAME);const o=t.preProcessDoc(document,globalThis,P);tt(o,a),e&&M.processors.frameTree.cleanup(e),t.postProcessDoc(document,o.markedElements,o.invalidElements),P.userScriptEnabled&&n&&await n(t.ON_AFTER_CAPTURE_EVENT_NAME),V=!0,q=!1}}function J(){k&&P&&(P.autoSaveUnload||P.autoSaveLoadOrUnload||P.autoSaveDiscard||P.autoSaveRemove)?L||(globalThis.addEventListener("unload",Q),document.addEventListener("visibilitychange",K),L=!0):(globalThis.removeEventListener("unload",Q),document.removeEventListener("visibilitychange",K),L=!1)}function K(){"hidden"==document.visibilityState&&P.autoSaveDiscard&&Y({autoSaveDiscard:P.autoSaveDiscard})}function Q(){!V&&(P.autoSaveUnload||P.autoSaveLoadOrUnload||P.autoSaveRemove)&&Y({autoSaveUnload:P.autoSaveUnload,autoSaveRemove:P.autoSaveRemove})}function Y({autoSaveUnload:t,autoSaveDiscard:n,autoSaveRemove:e}){const a=M.helper,o=window._singleFile_waitForUserScript;let s=[];!P.removeFrames&&globalThis.frames&&globalThis.frames.length&&(s=M.processors.frameTree.getSync(P)),P.userScriptEnabled&&o&&o(a.ON_BEFORE_CAPTURE_EVENT_NAME);tt(a.preProcessDoc(document,globalThis,P),s,{autoSaveUnload:t,autoSaveDiscard:n,autoSaveRemove:e})}function tt(t,n,{autoSaveUnload:e,autoSaveDiscard:a,autoSaveRemove:o}={}){const s=M.helper,r=M.pageInfo.updatedResources,i=M.pageInfo.visitDate.getTime();Object.keys(r).forEach((t=>r[t].retrieved=!1)),browser.runtime.sendMessage({method:"autosave.save",tabId:_,tabIndex:z,taskId:P.taskId,content:s.serialize(document),canvases:t.canvases,fonts:t.fonts,stylesheets:t.stylesheets,images:t.images,posters:t.posters,usedFonts:t.usedFonts,shadowRoots:t.shadowRoots,videos:t.videos,referrer:t.referrer,frames:n,url:location.href,updatedResources:r,visitDate:i,autoSaveUnload:e,autoSaveDiscard:a,autoSaveRemove:o})}async function nt(){const t=u({content:await G(),filename:decodeURIComponent(location.href.match(/^.*\/(.*)$/)[1])});for await(const n of t)await browser.runtime.sendMessage({method:"editor.open",data:Array.from(n)});await browser.runtime.sendMessage({method:"editor.open"})}function et(t){const n=M.helper,e=t.documentElement.firstChild;return""==t.documentElement.dataset.sfz||e.nodeType==Node.COMMENT_NODE&&e.textContent.includes(n.COMMENT_HEADER)}M.pageInfo={updatedResources:{},visitDate:new Date},browser.runtime.sendMessage({method:"bootstrap.init"}).then((t=>{P=t.optionsAutoSave;const n=t.options;_=t.tabId,z=t.tabIndex,k=t.autoSaveEnabled,n&&n.autoOpenEditor&&et(document)?"loading"==document.readyState?document.addEventListener("DOMContentLoaded",(()=>nt())):nt():"loading"==document.readyState?document.addEventListener("DOMContentLoaded",J):J()})),browser.runtime.onMessage.addListener((t=>{if(k&&"content.autosave"==t.method||"content.maybeInit"==t.method||"content.init"==t.method||"content.openEditor"==t.method||"devtools.resourceCommitted"==t.method||"singlefile.fetchResponse"==t.method)return X(t)})),document.addEventListener("DOMContentLoaded",Z,!1),globalThis.window==globalThis.top&&location&&location.href&&(location.href.startsWith("file://")||location.href.startsWith("content://"))&&("loading"==document.readyState?document.addEventListener("DOMContentLoaded",W,!1):W())}();
