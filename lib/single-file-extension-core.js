!function(n,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((n="undefined"!=typeof globalThis?globalThis:n||self).extension={})}(this,(function(n){"use strict";let t,e;const a=["lib/chrome-browser-polyfill.js","lib/single-file.js"],r=["lib/chrome-browser-polyfill.js","lib/single-file-frames.js"],i="../../../";async function c(n,i){let c;if(await async function(n){const i=n.extensionScriptFiles||[];t||e||([t,e]=await Promise.all([s(a.concat(i)),s(r)]))}(i),!i.removeFrames)try{await browser.tabs.executeScript(n,{code:e,allFrames:!0,matchAboutBlank:!0,runAt:"document_start"})}catch(n){}try{await browser.tabs.executeScript(n,{code:t,allFrames:!1,runAt:"document_idle"}),c=!0}catch(n){}return c&&i.frameId&&await browser.tabs.executeScript(n,{code:"document.documentElement.dataset.requestedFrameId = true",frameId:i.frameId,matchAboutBlank:!0,runAt:"document_start"}),c}async function s(n){const t=n.map((async n=>{if("function"==typeof n)return"("+n.toString()+")();";{const t=await fetch(browser.runtime.getURL(i+n));return(new TextDecoder).decode(await t.arrayBuffer())}}));let e="";for(const n of t)e+=await n;return e}const o=0,u=[o],f=Symbol(),w=new TextEncoder,y=new TextDecoder,l=new Array(256);let d=0;function h(n,t,e,a){if(void 0===a){if(d++,!(l.length-d>=u.length))throw new Error("Reached maximum number of custom types");l[l.length-d]={serialize:n,parse:t,test:e}}else l[a]={serialize:n,parse:t,test:e}}async function m(n,t){const e=l.findIndex((({test:e}={})=>e&&e(t,n)));n.addObject(t),await n.append(new Uint8Array([e]));const a=l[e].serialize;a&&await a(n,t),e!=o&&P(t)&&(await async function(n,t){const e=Object.getOwnPropertySymbols(t),a=e.map((n=>[n,t[n]]));await b(n,a)}(n,t),await async function(n,t){let e=Object.entries(t);T(t)&&(e=e.filter((([n])=>!M(Number(n)))));await m(n,e.length);for(const[t,a]of e)await p(n,t),await m(n,a)}(n,t))}async function b(n,t){await m(n,t.length);const e=Object.keys(t).filter((n=>M(Number(n)))).map((n=>Number(n)));let a=0,r=e[a];for(const[i,c]of t.entries())r==i?(r=e[++a],await m(n,c)):await m(n,f)}async function p(n,t){const e=w.encode(t);await m(n,e.length),await n.append(e)}async function g(n,t){await m(n,t.length),await n.append(new Uint8Array(t.buffer))}async function A(n,t){const e=new Uint8Array(new Float64Array([t]).buffer);await n.append(e)}async function j(n,t){const e=new Uint8Array([Number(t)]);await n.append(e)}h((async function(n,t){const e=n.objects.indexOf(t);await m(n,e)}),(async function(n){const t=await x(n);return new v(t,n)}),(function(n,t){return P(n)&&t.objects.includes(n)}),o),h(null,(function(){return{}}),P),h(b,S,T),h(p,F,(function(n){return"string"==typeof n})),h(g,(async function(n){const t=await x(n),e=await n.consume(8*t);return new Float64Array(e.buffer)}),(function(n){return n instanceof Float64Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(4*t);return new Float32Array(e.buffer)}),(function(n){return n instanceof Float32Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(4*t);return new Uint32Array(e.buffer)}),(function(n){return n instanceof Uint32Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(4*t);return new Int32Array(e.buffer)}),(function(n){return n instanceof Int32Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(2*t);return new Uint16Array(e.buffer)}),(function(n){return n instanceof Uint16Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(2*t);return new Int16Array(e.buffer)}),(function(n){return n instanceof Int16Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(t);return new Uint8ClampedArray(e.buffer)}),(function(n){return n instanceof Uint8ClampedArray})),h(g,(async function(n){const t=await x(n);return await n.consume(t)}),(function(n){return n instanceof Uint8Array})),h(g,(async function(n){const t=await x(n),e=await n.consume(t);return new Int8Array(e.buffer)}),(function(n){return n instanceof Int8Array})),h((async function(n,t){await m(n,t.byteLength),await n.append(new Uint8Array(t))}),(async function(n){const t=await x(n);return(await n.consume(t)).buffer}),(function(n){return n instanceof ArrayBuffer})),h(A,E,D),h((async function(n,t){const e=new Uint8Array(new Uint32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Uint32Array(t.buffer)[0]}),(function(n){return M(n)&&n>=0&&n<=4294967295})),h((async function(n,t){const e=new Uint8Array(new Int32Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(4);return new Int32Array(t.buffer)[0]}),(function(n){return M(n)&&n>=-2147483648&&n<=2147483647})),h((async function(n,t){const e=new Uint8Array(new Uint16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Uint16Array(t.buffer)[0]}),(function(n){return M(n)&&n>=0&&n<=65535})),h((async function(n,t){const e=new Uint8Array(new Int16Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(2);return new Int16Array(t.buffer)[0]}),(function(n){return M(n)&&n>=-32768&&n<=32767})),h((async function(n,t){const e=new Uint8Array([t]);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Uint8Array(t.buffer)[0]}),(function(n){return M(n)&&n>=0&&n<=255})),h((async function(n,t){const e=new Uint8Array(new Int8Array([t]).buffer);await n.append(e)}),(async function(n){const t=await n.consume(1);return new Int8Array(t.buffer)[0]}),(function(n){return M(n)&&n>=-128&&n<=127})),h(null,(function(){return}),(function(n){return void 0===n})),h(null,(function(){return null}),(function(n){return null===n})),h(null,(function(){return NaN}),(function(n){return Number.isNaN(n)})),h(j,N,(function(n){return"boolean"==typeof n})),h((async function(n,t){await p(n,t.description)}),(async function(n){const t=await F(n);return Symbol(t)}),k),h(null,(function(){return f}),z),h((async function(n,t){const e=t.entries();await m(n,t.size);for(const[t,a]of e)await m(n,t),await m(n,a)}),(async function(n){const t=await x(n),e=new Map;t&&await async function a(r=0){const i=await x(n),c=await x(n);n.setObject([i,c],((n,t)=>e.set(n,t))),r<t-1&&await a(r+1)}();return e}),(function(n){return n instanceof Map})),h((async function(n,t){await m(n,t.size);for(const e of t)await m(n,e)}),(async function(n){const t=await x(n),e=new Set;t&&await async function a(r=0){const i=await x(n);n.setObject([i],(n=>e.add(n))),r<t-1&&await a(r+1)}();return e}),(function(n){return n instanceof Set})),h((async function(n,t){await A(n,t.getTime())}),(async function(n){const t=await E(n);return new Date(t)}),(function(n){return n instanceof Date})),h((async function(n,t){await p(n,t.message),await p(n,t.stack)}),(async function(n){const t=await F(n),e=await F(n),a=new Error(t);return a.stack=e,a}),(function(n){return n instanceof Error})),h((async function(n,t){await p(n,t.source),await p(n,t.flags)}),(async function(n){const t=await F(n),e=await F(n);return new RegExp(t,e)}),(function(n){return n instanceof RegExp})),h((async function(n,t){await p(n,t.valueOf())}),(async function(n){return new String(await F(n))}),(function(n){return n instanceof String})),h((async function(n,t){await A(n,t.valueOf())}),(async function(n){return new Number(await E(n))}),(function(n){return n instanceof Number})),h((async function(n,t){await j(n,t.valueOf())}),(async function(n){return new Boolean(await N(n))}),(function(n){return n instanceof Boolean}));class v{constructor(n,t){this.index=n,this.data=t}getObject(){return this.data.objects[this.index]}}class I{constructor(n){this.stream=new U(n),this.objects=[],this.setters=[]}consume(n){return this.stream.consume(n)}getObjectId(){const n=this.objects.length;return this.objects.push(void 0),n}resolveObject(n,t){(function(n){return P(n)||k(n)})(t)&&!B(t)&&(this.objects[n]=t)}setObject(n,t){this.setters.push({functionArguments:n,setterFunction:t})}executeSetters(){this.setters.forEach((({functionArguments:n,setterFunction:t})=>{t(...n.map((n=>B(n)?n.getObject():n)))}))}}class U{constructor(n){this.offset=0,this.value=new Uint8Array(0),this.consumeData=n}async consume(n){if(this.offset+n>this.value.length){const t=this.value.subarray(this.offset,this.value.length),e=await this.consumeData();return t.length+e.length!=this.value.length&&(this.value=new Uint8Array(t.length+e.length)),this.value.set(t),this.value.set(e,t.length),this.offset=0,this.consume(n)}{const t=this.value.slice(this.offset,this.offset+n);return this.offset+=t.length,t}}}function O(){let n,t,e,a,r,i;return{next:async t=>t?async function(t){r?await r:async function(){let t;a=new Promise((n=>t=n)),n=new I(s),c();const e=await x(n);n.executeSetters(),t(e)}().catch((()=>{}));return function(){r=new Promise((n=>i=n))}(),e(t),{done:!1}}(t):{value:await a,done:!0},return:()=>({done:!0})};function c(){t=new Promise((n=>e=n))}async function s(){const n=await t;return c(),i&&i(),n}}async function x(n){const t=(await n.consume(1))[0],e=l[t].parse,a=n.getObjectId(),r=await e(n);return t!=o&&P(r)&&(await async function(n,t){const e=await S(n);n.setObject([e],(n=>n.forEach((([n,e])=>t[n]=e))))}(n,r),await async function(n,t){const e=await x(n);e&&await a();async function a(r=0){const i=await F(n),c=await x(n);n.setObject([c],(n=>t[i]=n)),r<e-1&&await a(r+1)}}(n,r)),n.resolveObject(a,r),r}async function S(n){const t=await x(n),e=new Array(t);return t&&await async function a(r=0){const i=await x(n);z(i)||n.setObject([i],(n=>e[r]=n));r<t-1&&await a(r+1)}(),e}async function F(n){const t=await x(n),e=await n.consume(t);return y.decode(e)}async function E(n){const t=await n.consume(8);return new Float64Array(t.buffer)[0]}async function N(n){const t=await n.consume(1);return Boolean(t[0])}function B(n){return n instanceof v}function P(n){return n===Object(n)}function T(n){return"number"==typeof n.length}function z(n){return n===f}function D(n){return"number"==typeof n}function M(n){return D(n)&&Number.isInteger(n)}function k(n){return"symbol"==typeof n}const q="single-filez-request-fetch",L="single-filez-ack-fetch",R="single-filez-response-fetch",_="Host fetch error (SingleFileZ)",C=2500,J=Boolean(window.wrappedJSObject),H=(n,t,e)=>window.addEventListener(n,t,e),Z=n=>window.dispatchEvent(n),G=(n,t,e)=>window.removeEventListener(n,t,e),K=(n,t)=>window.fetch(n,t);let Q=0,V=new Map;async function W(n,t={}){try{const e={cache:"force-cache",headers:t.headers};return await(t.referrer&&J?async function(n,t){const e=new Promise(((e,a)=>{Z(new CustomEvent(q,{detail:JSON.stringify({url:n,options:t})})),H(L,c,!1),H(R,i,!1);const r=setTimeout((()=>{s(),a(new Error(_))}),C);function i(t){t.detail?t.detail.url==n&&(s(),t.detail.response?e({status:t.detail.status,headers:new Map(t.detail.headers),arrayBuffer:async()=>t.detail.response}):a(t.detail.error)):a()}function c(){clearTimeout(r)}function s(){G(R,i,!1),G(L,c,!1)}}));try{return await e}catch(e){if(e&&e.message==_)return K(n,t);throw e}}(n,e):K(n,e))}catch(e){Q++;const a=new Promise(((n,t)=>V.set(Q,{resolve:n,reject:t,parser:O()})));return await Y({method:"singlefile.fetch",url:n,requestId:Q,referrer:t.referrer,headers:t.headers}),a}}async function X(n,t){const e=await Y({method:"singlefile.fetchFrame",url:n,frameId:t.frameId,referrer:t.referrer,headers:t.headers});return{status:e.status,headers:new Map(e.headers),arrayBuffer:async()=>new Uint8Array(e.array).buffer}}async function Y(n){const t=await browser.runtime.sendMessage(n);if(!t||t.error)throw new Error(t&&t.error&&t.error.toString());return t}browser.runtime.onMessage.addListener((n=>"singlefile.fetchFrame"==n.method&&window.frameId&&window.frameId==n.frameId?async function(n){try{const t=await K(n.url,{cache:"force-cache",headers:n.headers});return{status:t.status,headers:[...t.headers],array:Array.from(new Uint8Array(await t.arrayBuffer()))}}catch(n){return{error:n&&n.toString()}}}(n):"singlefile.fetchResponse"==n.method?async function(n){let t=V.get(n.requestId);if(t){const e=await t.parser.next(n.data);if(e.done){V.delete(n.requestId);const a=e.value;a.error?t.reject(new Error(a.error)):t.resolve({status:a.status,headers:{get:n=>a.headers&&a.headers[n]},arrayBuffer:async()=>a.array.buffer})}}return{}}(n):void 0)),n.getPageData=function(n,t,e,a={fetch:W,frameFetch:X}){return globalThis.singlefile.getPageData(n,a,t,e)},n.injectScript=function(n,t){return c(n,t)},Object.defineProperty(n,"__esModule",{value:!0})}));
